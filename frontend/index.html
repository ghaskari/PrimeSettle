<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ClearLedger â€“ Simple Frontend</title>
  <style>
    body { font-family: sans-serif; max-width: 800px; margin: 20px auto; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 6px 8px; text-align: left; }
    input { padding: 4px 6px; margin: 2px; }
    button { padding: 6px 10px; margin: 4px 2px; cursor: pointer; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; }
  </style>
</head>
<body>
  <h1>ðŸ’¸ ClearLedger â€” HTML + JS</h1>

  <h2>Add Transaction</h2>
  <div class="row">
    <input id="debtor" placeholder="Debtor" />
    <input id="creditor" placeholder="Creditor" />
    <input id="amount" type="number" placeholder="Amount" />
    <button onclick="addTransaction()">Add</button>
  </div>

  <h2>Current Transactions</h2>
  <table id="tx-table">
    <thead>
      <tr><th>Debtor</th><th>Creditor</th><th>Amount</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <button onclick="calculate()">Calculate</button>
  <button onclick="resetAll()">Reset</button>

  <h2>Balances</h2>
  <table id="balances-table">
    <thead>
      <tr><th>Name</th><th>Final Balance</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <h2>Settlements</h2>
  <table id="settlements-table">
    <thead>
      <tr><th>From</th><th>To</th><th>Amount</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <h2>QR & Exports</h2>
  <button onclick="showQR()">Show QR</button>
  <button onclick="downloadInvoice()">Download Invoice PDF</button>
  <button onclick="showChart()">Show Balance Chart</button>

  <div id="qr-container"></div>
  <div id="chart-container"></div>

  <script>
    const apiBase = "http://localhost:5000";

    let transactions = [];

    function renderTransactions() {
      const tbody = document.querySelector("#tx-table tbody");
      tbody.innerHTML = "";
      transactions.forEach(tx => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${tx.debtor}</td>
          <td>${tx.creditor}</td>
          <td>${tx.amount}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function addTransaction() {
      const debtor = document.getElementById("debtor").value.trim();
      const creditor = document.getElementById("creditor").value.trim();
      const amount = parseFloat(document.getElementById("amount").value);

      if (!debtor || !creditor || !amount) {
        alert("Fill all fields");
        return;
      }

      transactions.push({ debtor, creditor, amount });
      renderTransactions();

      document.getElementById("debtor").value = "";
      document.getElementById("creditor").value = "";
      document.getElementById("amount").value = "";
    }

    async function calculate() {
      const res = await fetch(apiBase + "/api/calculate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ transactions })
      });
      const data = await res.json();

      const balBody = document.querySelector("#balances-table tbody");
      const setBody = document.querySelector("#settlements-table tbody");
      balBody.innerHTML = "";
      setBody.innerHTML = "";

      data.balances.forEach(b => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${b.name}</td><td>${b.finalBalance}</td>`;
        balBody.appendChild(tr);
      });

      data.settlements.forEach(s => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${s.from}</td><td>${s.to}</td><td>${s.amount}</td>`;
        setBody.appendChild(tr);
      });
    }

    async function showQR() {
      const res = await fetch(apiBase + "/api/qr", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ transactions })
      });
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);

      const div = document.getElementById("qr-container");
      div.innerHTML = `<h3>QR</h3><img src="${url}" width="250" />`;
    }

    async function downloadInvoice() {
      const res = await fetch(apiBase + "/api/invoice-pdf", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ transactions })
      });
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "settlement_invoice.pdf";
      a.click();
      URL.revokeObjectURL(url);
    }

    async function showChart() {
      const res = await fetch(apiBase + "/api/balance-chart", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ transactions })
      });
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);

      const div = document.getElementById("chart-container");
      div.innerHTML = `<h3>Balance Chart</h3><img src="${url}" width="400" />`;
    }

    function resetAll() {
      transactions = [];
      renderTransactions();
      document.querySelector("#balances-table tbody").innerHTML = "";
      document.querySelector("#settlements-table tbody").innerHTML = "";
      document.getElementById("qr-container").innerHTML = "";
      document.getElementById("chart-container").innerHTML = "";
    }
  </script>
</body>
</html>
